
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>caines.ca</title>
	<meta name="author" content="Gregg Caines">

	
	<meta name="description" content="Jun 2nd, 2014 metrics, node.js,, programming,, quality, Production-Quality Node.js Web Apps : Part II, Detecting Defects This is the second part of &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="caines.ca" type="application/atom+xml">
	
	<link rel="canonical" href="http://caines.ca/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-10626105-4']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("gregg@caines.ca") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Latest</a></li>

  
  <li><a href="/blog/2014/06/02/production-quality-node-dot-js-web-apps-part-ii/">Production-Quality Node.js Web Apps : Part II, Detecting Defects</a></li>
  
  <li><a href="/blog/2014/06/01/production-quality-node-dot-js-web-apps-part-i/">Production-Quality Node.js Web Apps : Part I, The Basics</a></li>
  
  <li><a href="/blog/2014/01/11/in-defence-of-the-office/">In Defence Of The Office</a></li>
  
  <li><a href="/blog/2013/09/13/you-probably-dont-need-to-version-your-web-api/">You probably don’t need to version your web API.</a></li>
  
  <li><a href="/blog/2013/06/09/my-favourite-new-ility/">My Favourite New Ility</a></li>
  
  <li><a href="/blog/2013/05/07/a-requiem-for-a-team/">A Requiem for a Team</a></li>
  
  <li><a href="/blog/2013/04/29/so-i-wrote-a-json-api-framework-and-the-framework-was-the-least-interesting-part/">So I wrote a JSON API Framework and the Framework was the Least Interesting Part</a></li>
  
  <li><a href="/blog/2013/04/21/3-terrible-anti-patterns-for-error-handling-in-rest-apis/">3 Terrible Anti-patterns for Error-Handling in 'REST' APIs:</a></li>
  
    </section>

    <!-- <li><a href="/blog/archives">Archives</a></li> -->
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:gregg@caines.ca" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/@greggcaines" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/cainus" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-06-02T17:41:31-07:00" data-updated="true" itemprop="datePublished">Jun 2<span>nd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/metrics/'>metrics</a>, <a class='category' href='/blog/categories/node-dot-js/'>node.js,</a>, <a class='category' href='/blog/categories/programming/'>programming,</a>, <a class='category' href='/blog/categories/quality/'>quality,</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/06/02/production-quality-node-dot-js-web-apps-part-ii/" itemprop="url">Production-Quality Node.js Web Apps : Part II, Detecting Defects</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>This is the second part of a three part series on making node.js web apps that are (what I would consider to be) production quality.  The <a href="http://caines.ca/blog/programming/production-quality-node-js-web-apps-part-i-the-basics/">first part</a> really just covered the basics, so if you&rsquo;re missing some aspect covered in the basics, you&rsquo;re likely going to have some issues with the approaches discussed here.</p>

<p>First, I&rsquo;m going to talk about a few major classes of defects and how to <strong>detect</strong> them.</p>

<p>I could go straight to talking about preventing/avoiding them, but detection is really the first step.  You&rsquo;re simply not going to get a low-defect rate by just using prevention techniques without also using detection techniques.  Try to avoid the junior engineer mindset of assuming that &ldquo;being really careful&rdquo; is enough to achieve a low defect rate.  You can get a much lower defect rate and move much faster by putting systems in place where your running application is actively telling <em>you</em> about defects that it encounters.  This really is a case where working smart pays much higher dividends than working hard.</p>

<h2>The types of defects you&rsquo;re most likely to encounter</h2>

<p>I&rsquo;m a huge fan of constantly measuring the quality aspects that are measurable.  You&rsquo;re not going to detect all possible bugs this way, but you <em>will</em> find a lot of them, and detection this way is a lot more comprehensive than manual testing and a lot faster than waiting for customers to complain.</p>

<p>There are (at least) 4 types of error scenarios that you&rsquo;re going to want to eliminate:<br/>
* restarts
* time-outs
* 500s
* logged errors</p>

<h3>Restarts</h3>

<p>Assuming you&rsquo;ve got a service manager to restart your application when it fails and a cluster manager to restart a chlid process when one fails (like I talked about in <a href="http://caines.ca/blog/programming/production-quality-node-js-web-apps-part-i-the-basics/">Part I</a>), one of the worst types of error-scenarios that you&rsquo;re likely to encounter will be when a child process dies and has to restart.  It&rsquo;s a fairly common mistke to believe that once you have automatic restarting working, process failure is no longer a problem.  That&rsquo;s really only the beginning of a solution to the problem though.  Here&rsquo;s why:</p>

<ul>
<li><p>Node.js is built to solve the <a href="http://www.kegel.com/c10k.html">C10K problem</a>, so you should expect to have a high number of requests per process in progress at any given time.</p></li>
<li><p>The node process itself handles your web-serving, and there&rsquo;s no built-in request isolation like you might find in other frameworks like PHP, where one request can&rsquo;t have any direct effects on another request.  With a node.js web application, any uncaught exception or unhandled <code>error</code> event will bring down the entire server, including your thousands of connections in progress.</p></li>
<li><p>Node.js&rsquo;s asynchronous nature and multiple ways to express errors (exceptions, error events, and callback parameters) make it difficult to anticipate or catch errors more holistically as your codebase gets larger, more complex, and has more external or 3rd-party dependencies.</p></li>
</ul>


<p>These three factors combine to make restarts both deadly and difficult to avoid unless you&rsquo;re very careful.</p>

<p><strong>Detection</strong>: The easiest way to detect these is to put metrics and logging at the earliest place in both your cluster child code and your cluster master code to tell you when the master or child processes start.  If you want to remove the noise caused by new servers starting up, or normal deployments, then you may want to write something a little more complex that can specifically detect abnormal restarts (I&rsquo;ve got a tiny utility for that called <a href="https://github.com/cainus/restart-o-meter">restart-o-meter</a> too).</p>

<p>You might have an aggregated logging solution than can send you alerts based on substrings that it finds in the logs too, or that can feed directly into a time-series metrics system.</p>

<h3>Time-outs</h3>

<p>Time-outs are another type of failed request, where the server didn&rsquo;t respond within some threshold that you define.  This is pretty common if you forget to call <code>res.end()</code>, or a response just takes too long.</p>

<p><strong>Detection</strong>:  You can just write a quick and dirty middleware like this to detect them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">timeoutThreshold</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="c1">// 10 seconds</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">timeoutCheck</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">metrics</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="s2">&quot;slowRequest&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;slow request: &quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span><span class='line'>  <span class="p">},</span> <span class="nx">timeoutThreshold</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">timeoutCheck</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">next</span><span class="p">();</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>(or you can grab <a href="https://www.npmjs.org/package/connect-settimeout">this middleware I wrote</a> that does basically the same thing).</p>

<h3>500s</h3>

<p>On a web application, one of the first things I want to ensure is that we&rsquo;re using proper status codes.  This isn&rsquo;t just HTTP nerd talk (though no one will say I&rsquo;m innocent of that), but rather a great system of easily categorizing the nature of your traffic going through your site.  I&rsquo;ve written about <a href="http://caines.ca/blog/programming/3-terrible-anti-patterns-for-error-handling-in-rest-apis/">the common anti-patterns here</a>, but the gist of it is:</p>

<h5>Respond with 500-level errors if the problem was a bug in your app, and not in the client.</h5>

<p>This lets you know that there was a problem, and it&rsquo;s your fault.  Most likely you only ever need to know <code>500 Internal Server Error</code> to accomplish this.</p>

<h5>Respond with 400-level errors if the problem was a bug in the client.</h5>

<p>This lets you know that there was a problem and it was the client app&rsquo;s fault.  If you learn these 4 error codes, you&rsquo;ll have 90% of the cases covered:
* 400 Bad Request  &mdash; When it&rsquo;s a client error, and you don&rsquo;t have a better code than this, use this.  You can always give more detail in the response body.
* 401 Not Authenticated &mdash; When they need to be logged in, but aren&rsquo;t.
* 403 Forbidden &mdash; When they&rsquo;re not allowed to do do something
* 404 Not Found &mdash; When a url doesn&rsquo;t point to an existing thing.</p>

<p>If you don&rsquo;t use these status codes properly, you won&rsquo;t be able to distinguish between:
* successes and errors
* errors that are the server&rsquo;s responsibility and errors that are the client&rsquo;s responsibility.</p>

<p>These distinctions are dead-simple to make and massively important for determining if errors are occuring, and if so, where to start debugging.</p>

<p>If you&rsquo;re in the context of a request and you know to expect exceptions or error events from a specific piece of code, but don&rsquo;t know/care exactly what type of exception, you&rsquo;re probably going to want to log it with console.error() and respond with a 500, indicating to the user that there&rsquo;s a problem with your service.  Here are a couple of common scenarios:</p>

<ul>
<li>the database is down, and this request needs it</li>
<li>some unexpected error is caught</li>
<li>some api for sending email couldn&rsquo;t connect to the smtp service</li>
<li>etc, etc</li>
</ul>


<p>These are all legitimate 500 scenarios that tell the user &ldquo;hey the problem is on our end, and there&rsquo;s no problem with your request.  You may be able to retry the exact same request later&rdquo;.  A number of the &ldquo;unexpected errors&rdquo; that you might catch though will indicate that your user actually did send some sort of incorrect request.  In that case, you want to respond with a reasonable 4xx error instead (often just a 400 for &ldquo;Bad Request&rdquo;) that tells them what they did wrong.</p>

<p>Either way, you generally don&rsquo;t want 500s at all.  I get rid of them by fixing the issues that caused them, or turning them into 4xxs where appropriate (eg. when bad user input is causing the 500), to tell the client that the problem is on their end.  The only times that I don&rsquo;t try to change a response from a 500 is when it really is some kind of internal server error (like the database is down), and not some programming error on my part or a bad client request.</p>

<p><strong>Detection</strong>:  500s are important enough that you&rsquo;re going to want to have a unified solution for them.  There should be some simple function that you can call in all cases where you plan to respond with a 500 that will log your 500, the error that caused it, and the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/Stack">.stack property</a> of that error, as well as incrementing a metric, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">internalServerError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">body</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;500 &quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">metrics</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="s2">&quot;internalServerError&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Having a unified function you can call like this (possibly monkey-patched onto the response object by a middleware, for convenience) gives you the ability to change how 500&rsquo;s are logged and tracked everywhere, which is good, because you&rsquo;ll probably want to tweak it fairly often.</p>

<p>You&rsquo;re probably actually going to use this on <em>most</em> asynchronous functions in your HTTP handling code (controllers?) that you call that you don&rsquo;t expect an error on.  Here&rsquo;s an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">db</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">someId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">internalServerError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="s2">&quot;Internal Server Error&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>        <span class="c1">// and normal stuff with the user object goes here</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, I just expect to get a user back, and not get any errors (like the database is disconnected, or something), so I just put the 500 handler in the case that an <code>err</code> object is passed, and go back to my happy-path logic.  If 500s start to show up there at runtime, I&rsquo;ll be able to decide if they should be converted to a 4xx error, or fixed.</p>

<p>For example if I start seeing errors where err.message is &ldquo;User Not Found&rdquo;, as if the client requested a non-existant user, I might add 404 handling like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">db</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">someId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">===</span> <span class="s2">&quot;User Not Found&quot;</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">&quot;User not found!&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">internalServerError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="s2">&quot;Internal Server Error&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>        <span class="c1">// and normal stuff with the user object goes here</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Conversely, if I start seeing errors where err.message is &ldquo;Database connection lost&rdquo;, which is a valid 500 scenario, I might not add any specific handling for that scenario.  Instead, I&rsquo;d start looking into solving how the database connection is getting lost.</p>

<p>If you&rsquo;re building a JSON API, I&rsquo;ve got a great middleware for unified error-handling (and status codes in general) called <a href="https://github.com/cainus/json-status">json-status</a>.</p>

<p>A unified error handler like this leaves you with the ability to expand all internal server error handling later too, when you get additional ideas.  For example, We&rsquo;ve also added the ability for it to log the requesting user&rsquo;s information, if the user is logged in.</p>

<h3>Logged Errors</h3>

<p>I often make liberal use of <code>console.error()</code> to log errors and their <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/Stack">.stack properties</a> when debugging restarts and 500s, or just reporting different errors that shouldn&rsquo;t necessarily have impact on the http response code (like errors in fire-and-forget function calls where we don&rsquo;t care about the result enough to call the request a failure).</p>

<p><strong>Detection</strong>:  I ended up adding a method to <code>console</code> called <code>console.flog()</code> (You can name the method whatever you want, instead of &lsquo;flog&rsquo; of course!  I&rsquo;m just weird that way.) that acts just like <code>console.error()</code> (ultimately by calling it with the same arguments), but also increments a &ldquo;logged error&rdquo; metric like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">flog</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">increment</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">metrics</span><span class="p">.</span><span class="nx">increment</span><span class="p">(</span><span class="s2">&quot;loggedErrors&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// assume `metrics` is required earlier</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s2">&quot;testing&quot;</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s2">&quot;LOGGED ERROR:&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// put a prefix on error logs to make them easier to search for</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this in place, you can convert all your <code>console.error()</code>s to <code>console.flog()</code>s and your metrics will be able to show you when logged errors are increasing.</p>

<p>It&rsquo;s nice to have it on <code>console</code> because it sort of makes sense there and console is available everywhere without being specifically <code>require()</code>ed.  I&rsquo;m normally against this kind of flagrant monkey-patching, but it&rsquo;s really just <em>too</em> convenient in this case.</p>

<h4>Log Levels</h4>

<p>I should note too that I don&rsquo;t use traditional log levels (error/debug/info/trace) anymore, because I don&rsquo;t find them all that useful.  I&rsquo;m logging everything as an error or not, and I generally just strive to keep the logs free of everything other than lines that indicate the requests being made like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="nx">POST</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">session</span> <span class="mi">201</span>
</span><span class='line'>  <span class="nx">GET</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">status</span> <span class="mi">200</span>
</span><span class='line'>  <span class="nx">POST</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">passwordReset</span> <span class="mi">204</span>
</span><span class='line'>  <span class="nx">GET</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">admin</span><span class="p">.</span><span class="nx">php</span> <span class="mi">404</span>
</span><span class='line'>  <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>That doesn&rsquo;t mean that I don&rsquo;t sometimes need debug output, but it&rsquo;s so hard to know what debug output I need in advance that I just add it as needed and redeploy.  I&rsquo;ve just never found other log-levels to be useful.</p>

<h2>More About Metrics</h2>

<p>All of the efforts above have been to make defects self-reporting and visible.  Like I said in the first part of this series, the greatest supplement to logging that I&rsquo;ve found is the time-series metrics graph.  Here&rsquo;s how it actually looks (on a live production system) in practice for the different types of defects that have been discussed here.</p>

<p><img src="/images/bad_stuff.png" title="[metrics : restarts, 500s, logged errors, timeouts [metrics : restarts, 500s, logged errors, timeouts]]" ></p>

<p>The way to make metrics most effective, is to keep them on a large video display in the room where everyone is working.  It might seem like this shouldn&rsquo;t make a difference if everyone can just go to their own web browsers to see the dashboard whenever they want, but it absolutely has a huge difference in impact.  Removing that minor impediment and just having metrics always available at a glance results in people checking them far more often.</p>

<p>Without metrics like this, and a reasonable aggregated logging solution, you are really flying blind, and won&rsquo;t have any idea what&rsquo;s going on in your system from one deployment to the next.  I personally can&rsquo;t imagine going back to my old ways that didn&rsquo;t have these types of instrumentation.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-06-01T10:09:00-07:00" data-updated="true" itemprop="datePublished">Jun 1<span>st</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/node-dot-js/'>node.js,</a>, <a class='category' href='/blog/categories/programming/'>programming,</a>, <a class='category' href='/blog/categories/quality/'>quality</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/06/01/production-quality-node-dot-js-web-apps-part-i/" itemprop="url">Production-Quality Node.js Web Apps : Part I, the Basics</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I&rsquo;ve been working on production-quality node.js web applications for a couple of years now, and I thought it&rsquo;d be worth writing down some of the more interesting tricks that I&rsquo;ve learned along the way.</p>

<p>I&rsquo;m mostly going to talk about maintaining a low-defect rate and high availability, rather than get into the details about scaling that are covered in a lot of other places.   In particular, I’ll be talking about load-balancing, process management, logging, and metrics, and the how’s and why’s of each.</p>

<h3>Balance the Load</h3>

<p>I&rsquo;m going to assume that you&rsquo;re already load-balancing on a given server with <a href="http://nodejs.org/api/cluster.html">cluster</a> or some higher level abstraction ( I use <a href="https://github.com/isaacs/cluster-master">cluster-master</a>) as well as between servers with a load-balancer like <a href="http://haproxy.1wt.eu/">ha-proxy</a>.</p>

<p>Performance considerations aside, your service will have much better availability, quality, and uptime if you&rsquo;ve got multiple processes running on multiple machines.  More specifically, you get:
* the ability to immediately failover in the case of single process or single machine failure
* reduced overall service failure in the case of single process or single machine failure
* the ability to gracefully deploy with the load-balancer</p>

<h3>Gracefully Deploy</h3>

<p>Gracefully deploying means that your deploy process has enough servers running to handle the load at all times throughout the actual deployment process, and that none of the servers are taken off-line while outstanding requests are still in progress.  This means:</p>

<ul>
<li><p>Your clustering solution must be able to stop new connections and not exit the master process until all servers have finished processing their existing requests.  The solution I personally use is <a href="https://github.com/isaacs/cluster-master">cluster-master</a>, but there are bunch of suitable alternatives.</p></li>
<li><p>You need a rolling deployment, meaning that servers are restarted one-at-a-time, or in small groups, rather than all at once.  The easiest way to do this is probably to write a nice deploy script that takes restarting servers out of the load-balancer until they&rsquo;re running again.</p></li>
</ul>


<p>If you don&rsquo;t have a graceful deploy solution, every deployment of new code will lose requests in progress, and your users will have a terrible experience.</p>

<p>Also note: I&rsquo;ve seen a few clustering solutions that use some sort of hot-deploy (hot-deploy loads a new version of code without taking the server down) functionality.  If you&rsquo;ve got a rolling deploy via your load balancer though, you probably <em>don&rsquo;t</em> need any sort of hot-deploy functionality.  I&rsquo;d personally avoid solutions that involve the complexity of hot-deploying.</p>

<h3>Run as a Service</h3>

<p>You&rsquo;re also going to want to be running your app as a service that the OS knows to restart with some service manager like <a href="http://caolanmcmahon.com/posts/deploying_node_js_with_upstart/">upstart</a>.  A service manager like this is going to be absolutely essentially for when your node.js app crashes, or when you spin up new machines.</p>

<p>It&rsquo;s probably worth noting that you won&rsquo;t really want to use something like <a href="https://github.com/nodejitsu/forever">forever</a> or <a href="http://nodemon.io/">nodemon</a> in production, because it doesn&rsquo;t survive reboots, and is pretty redundant once you&rsquo;ve added service management that actually does (This is a case where you don&rsquo;t want redundancy, because these types of process managers can end up fighting with each other to restart the app, thus never really allowing the app to start).</p>

<h4>Log to Standard Output</h4>

<p>Logging to standard output (using <code>console.log()</code>) and standard error (using <code>console.error()</code>) is the simplest and most powerful way to log.  Here&rsquo;s how:</p>

<h5>pipe it, don&rsquo;t write it</h5>

<p>In the config file for running your app, you want something like this to specify a log file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>node server.js &gt;&gt; /var/log/myserver.log 2&gt;&amp;1
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The <code>&gt;&gt;</code> tells your node process to append output to the specified log file and the <code>2&gt;&amp;1</code> tells it that both standard out and standard error should go to that same log file.  You don&rsquo;t want to be writing to the logs programmatically from within the node process, because you will miss any output that you don&rsquo;t specifically log, like standard error output from node.js itself which happens anytime that your server crashes.  That kind of information is too critical to miss.</p>

<h5>console is the only &ldquo;logging library&rdquo; you need</h5>

<p>With this kind of logging set up, I just have to <code>console.log()</code> for any debug output that I need (usually just temporarily for a specific issue that I&rsquo;m trying to solve), or <code>console.error()</code> for any errors I encounter.</p>

<p>Additionally, one of the first things I do on a new web service is to set up a <code>console.log()</code> for each request (this should work in any <code>express</code> or <code>connect</code> app):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;finish&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>This chunk of code gives me nice simple logs for every request that look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nx">POST</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">session</span> <span class="mi">400</span>
</span><span class='line'><span class="nx">POST</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">session</span> <span class="mi">401</span>
</span><span class='line'><span class="nx">POST</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">session</span> <span class="mi">200</span>
</span><span class='line'><span class="nx">GET</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">status</span> <span class="mi">200</span>
</span><span class='line'><span class="nx">GET</span> <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">status</span> <span class="mi">200</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<h5>rotating the logs</h5>

<p>The missing infrastructure needed to support this is a way to rotate the logs, like <a href="http://www.rackspace.com/knowledge_center/article/understanding-logrotate-part-1">logrotate</a>.  Once that&rsquo;s set up properly, your logs will rotate for you nicely and not fill up your disk on you.</p>

<h2>Tools to Help Detect Problems at Runtime</h2>

<p>There are two basic key ways that I like to instrument an application to detect problems that occur at runtime: Aggregated logging and metrics.</p>

<h4>Agreggated Logging</h4>

<p>One of the most important things you can do for error and defect detection is to have aggregated logging &mdash; some service that brings all your web servers&#8217; logs together into one large searchable log.  There are a few products for this:  The stand-out open source one for me seemed to be the <a href="http://www.elasticsearch.org/overview/kibana/">logstash/kibana combination</a>, though these days I&rsquo;m lazy and generally use the <a href="https://papertrailapp.com/">papertrail service</a> instead.</p>

<p>I would highly recommend that you set a service like this up immediately, because the small amount of friction involved in <code>ssh</code>ing into servers to <code>tail</code> logs is enough to seriously reduce how often you and your teammates will actually look at the logs. The sooner you set this up, the sooner you can benefit from being able to learn about your application through the logs that you have it write.</p>

<h4>Metrics</h4>

<p>When I say &ldquo;metrics&rdquo; I really mean time-series metrics, that allow me to see the frequency of different types of events over time.  These are invaluable because they</p>

<ul>
<li>tell you when something unusual is happening</li>
<li>aggregate certain types of data in ways that logs can&rsquo;t</li>
<li>help you rally the team or company around specific high-value goals (be careful with this one!)</li>
</ul>


<p>The stand-out metrics/graphic open source product is probably <a href="http://graphite.wikidot.com/">graphite</a>.  I&rsquo;ve generally been using <a href="https://metrics.librato.com">Librato&rsquo;s metrics service</a> though because it&rsquo;s easy to set up, and looks great, so that&rsquo;s where I&rsquo;ll pull my screenshots from for time-series data.  I&rsquo;ve also had a pretty good experience with <a href="http://datadog.com">DataDog&rsquo;s service</a> as well.  Both also come with the ability to raise alerts when a metric surpasses a threshold, which can be a nice way to know when something is going on that you should investigate.</p>

<h5>Basic Metrics</h5>

<p>There are a bunch of basic metrics that you can track to see what&rsquo;s going on in your server.</p>

<p>Here&rsquo;s an example of some very high-level metrics for us over a week:</p>

<p><img src="/images/metrics_requests_duration.png" title="[metrics : number of requests vs average duration [metrics : number of requests vs average duration]]" ></p>

<ul>
<li>in blue: number of requests</li>
<li>in green: average duration of requests</li>
</ul>


<p>(Note that at this resolution, the y-values are averages over such long durations that the values aren&rsquo;t really that useful at face value; it&rsquo;s the visualization of general trends that is useful.)</p>

<p>There are a few obvious things that should jump out right away in this example:</p>

<ul>
<li>We have daily traffic spikes with 5 peaks really standing out and 2 being almost flat (those happen to be Saturday and Sunday).</li>
<li>We had a spike in average request duration (on Friday morning &mdash; the third peak).  This was caused by some performance issues with our database, and resulted in service outage for a number of our users during that time.</li>
</ul>


<p>I can basically put <code>metrics.increment("someEventName");</code> anywhere in my codebase to tell my metrics service when a particular event occurred.</p>

<p>Also consider OS metrics like:
* disk space usage
* cpu utilization
* memory consumption
* etc, etc</p>

<p>I&rsquo;ve got my codebase set up so that <code>metrics.gauge("someMetricName", value);</code> will allow me to graph specific values like these over time as well.</p>

<p>If you&rsquo;re not already doing monitoring like this, you must be wondering what your servers would tell you.  When it&rsquo;s this easy, you tend to do it all the time and get all kinds of interesting metrics including more business-specific metrics.</p>

<h2>What next?</h2>

<p>These are really just the basics.  If you&rsquo;re not doing these things, and you care about running a production-quality web service, you&rsquo;re probably putting yourself at a disadvantage.</p>

<p>There is a lot more that you can do though, and I&rsquo;ll get into that in my next post, which will be Part II to this one.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-01-11T14:51:15-08:00" data-updated="true" itemprop="datePublished">Jan 11<span>th</span>, 2014</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/01/11/in-defence-of-the-office/" itemprop="url">In Defence of the Office</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I&rsquo;ve been reading the 37 signals book <a href="http://37signals.com/remote/">Remote</a> lately and it&rsquo;s got me thinking a lot about the advantages and disadvantages of working remotely.  While they clearly acknowledge that there are trade-offs to working remotely, I personally don&rsquo;t think they paint a very clear picture of just how expensive those trade-offs are.  I can only really speak from a software development perspective, but I think this might apply to other types of businesses where a high degree of collaboration is necessary and the concept of &ldquo;team&rdquo; is more than just &ldquo;a group of people&rdquo;.</p>

<p>After 7 or 8 years of being a home-based contract-worker, and close to the same time spent working in various office environments, I&rsquo;ve found that with the right people and the right environment, the office can be a lot more productive (and actually enjoyable) than a home environment, for a number of reasons.</p>

<p>Skype / Google Hangouts / Webex pale in comparison to actually being in the same room as someone else.  I can&rsquo;t explain why, because it seems to me like it should be good enough (and I really wish it were sometimes), but the fact of the matter is that it&rsquo;s not.  You miss nuances in communication that can add up to big differences in productivity.   I&rsquo;ve been in hours and hours of pair programming sessions over webex: it doesn&rsquo;t match the high-bandwidth of shoulder-to-shoulder pairing.  I&rsquo;ve done the shared whiteboard thing: it doesn&rsquo;t match the speed and simplicity of an actual whiteboard.</p>

<p>With communication over today&rsquo;s technological mediums, there&rsquo;s just a natural tendency to end the interaction as soon as possible &ldquo;and get back to work&rdquo; too, where people don&rsquo;t actually leave Skype / Google hangouts / webex running all day long.  The result is that people are reluctant to start new conversations like that because they&rsquo;re worried about interrupting the other person.  So people naturally fall back on less intrusive means of communication (text chat) and often even further back to more asynchronous forms of communication (email).</p>

<p>And asynchronous communication is not the boon to productivity that people think it is.  Email is today&rsquo;s definitive means of asynchronous communication, but I think it&rsquo;s pretty obvious that there are few methods of communication that are less efficient.  Imagine a sports team that can only communicate by email.  That would be ridiculous.  Email is amazing at its ability to cut down on interruptions of course, but it&rsquo;s at the obvious cost of timeliness and immediacy (not to mention the very real human aspects including general tone and emotional nuances!).</p>

<p>The ideal solution would be to solve the problem of interruptions without losing timeliness.</p>

<p>Explaining this really requires actually defining an &ldquo;interruption&rdquo;:  When you&rsquo;re on a team and someone wants to talk to you about the main goal of the team, that&rsquo;s decidedly NOT an interruption.  Imagine a quarterback being annoyed by the &ldquo;interruption&rdquo; of someone yelling that they&rsquo;re open for a pass.  Imagine a soldier in a firefight being annoyed at another soldier for requesting cover fire prior to some forward manoeuvring.  In order for something to really be an interruption, you have to be working on a different priority than the other person, one that you think is of higher priority.</p>

<p>In a collaborative environment, interruptions should often be viewed as a symptom, and not the actual cause, of the problem.  To solve the problem of interruptions at the root, you&rsquo;ve got to clearly define the priorities of the team, aligning everyone on those, and concentrating as many people as possible on the top goal rather than going the easy route (management-wise) and doing something like giving each of the X members of the team one of the top X priorities, effectively &ldquo;<a href="http://brodzinski.com/2013/11/multitasking-teams.html">team-multi-tasking</a>&rdquo;.  Team-multi-tasking is a common approach because:</p>

<ul>
<li><p>It&rsquo;s the easiest thing to do management-wise (Why bother prioritizing when I can have X tasks worked on at once?).</p></li>
<li><p>It feels like you&rsquo;re getting more done, because so many things are in progress at once.</p></li>
<li><p>It ensures everyone is 100% utilized.</p></li>
</ul>


<p>But it&rsquo;s also pretty obviously the absolute slowest way to get your top priority shipped and to start getting value from it  (and often <a href="http://www.startuplessonslearned.com/2011/09/power-of-small-batches.html">the slowest way to get them all done</a>, believe it or not!).</p>

<p>Not only that, but the more you do this, the more people tend to specialize into roles like &ldquo;the back-end guy&rdquo; or the &ldquo;<a href="http://en.wikipedia.org/wiki/DevOps">ops guy</a>&rdquo;, etc, and individuals lose the ability to be cross-functional, and to practice <a href="http://www.extremeprogramming.org/rules/collective.html">collective code ownership</a>.  It&rsquo;s a vicious cycle too: the more an individual tends toward deep specialization, the more we&rsquo;re tempted to give them that kind of work because they&rsquo;re the best at it.    Not only does your <a href="http://en.wikipedia.org/wiki/Bus_factor">bus factor</a> skyrocket, but you get back into these scenarios where anytime someone engages someone else for help, it&rsquo;s an interruption to that other person, so people tend to not ask for help when they really should, or they use dog-slow asynchronous methods (like email).  Breaking this cycle means constantly trying to break down these specialty silos for any given specialty by having more experienced people collaborate with (and often mentor) less experienced people.  The end result is a team that <em>makes</em> full-stack engineers and not just one that hires them.</p>

<p>I find that the right mindset for the team is to create an environment that would be best for a team working on only 1 super-important thing that you want to start getting value from as soon as possible.  A general rule of thumb is:  If you&rsquo;re having a text conversation with someone in the same room, you&rsquo;re doing it wrong.  I know that&rsquo;s common, but if you think about it, it&rsquo;s pretty absurd.</p>

<p><strong>How would that environment look?</strong>  It would be a &ldquo;<a href="http://www.sciencedaily.com/releases/2000/12/001206144705.htm">warroom</a>&rdquo; for <a href="http://www.ibimapublishing.com/journals/CIBIMA/2010/959194/959194.pdf">radically collocating</a> the team.  Everyone that needs to be there would be there, arranged in a manner that&rsquo;s most effective for verbal communication.  There would be nearby whiteboards for collaborative design sessions, and <a href="http://alistair.cockburn.us/Information+radiator">information radiators</a> to show the progress of the efforts and various other metrics of the current state of affairs by just glancing up.</p>

<p><strong>How would the team behave?</strong>  They would be a &ldquo;tiger team&rdquo;.  They would all be helping to get that one thing out the door.  They would almost never use any electronic means to communicate (except obviously, when it&rsquo;s more efficient, like sharing chunks of code, or urls), and you&rsquo;d never hear someone say &ldquo;that&rsquo;s not my job&rdquo;.  If someone is the only person that knows how to do something, the team identifies them as a process choke-point and quickly tries to get others up to speed on that skill or responsibility (and not by giving them links to docs or occasional hints, but by super-effective methods like <a href="http://www.extremeprogramming.org/rules/pair.html">pair programming</a>, in-person demonstration, and actual verbal discussion).  If one member of the team appears to be stuck, he asks for help, and if he doesn&rsquo;t, the other members notice, and jump in to help, unprompted.  There are no heroes, and everyone takes responsibility for everything that the team is tasked with.  This can and should be taken to extremes too:  members should drop their egos and make themselves available to do grunt work or testing for other members &mdash; whatever gets the top priority shipped as soon as reasonably (and sustainably) possible.  This includes making yourself vulnerable enough to ask for help from others, not only for tricky aspects of your work, but also just to divide your work up better.  If you&rsquo;re taking longer than expected on a given task, you should be conscious enough of that to be openly discussing it with the team, including possible solutions, and not trying to be a hero or a martyr.  Conversely, you should never be waiting for extended periods of time for your teammate to do some work that you depend on for something else.  If a teammate is taking longer than usual, jump in and help.</p>

<p><strong>How would management work then?</strong>  The team should self-organize.  With clear priorities set, the team can and should, for the most part, self-direct.  A manager should not try to manage the avalanche of interactions that happen during free-collaboration throughout the day.  Trying to manage who works on what, will simply make that manager a choke-point and slow the process down (and he/she will inevitably be wrong more than right, compared to the wisdom of the entire team).  Often a non-technical manager can have the advantage over more technical managers, because he&rsquo;s forced to trust the team&rsquo;s decisions and doesn&rsquo;t become an &ldquo;approval choke-point&rdquo; for the team&rsquo;s engineering decisions.</p>

<p>That doesn&rsquo;t mean a management role is unnecessary though; it&rsquo;s actually quite demanding to manage a team like this.  Priorities must always be crystal clear and for the most part, the top few priorities being worked on should not change very often.  If they do change often, you usually have either a management problem or a product quality problem.  Those problems should be fixed at the root as well, rather than making developers feel like management or customers are just a constant stream of interruptions.  Keep in mind that if you do change the top priority often enough, you can completely prevent the team from any progress at all (I&rsquo;ve spent months on a team like that before &mdash; it&rsquo;s not fun for anyone).  (For a more complete description of the ideal responsibilities for this style of management, see &ldquo;The Management&rdquo; <a href="http://caines.ca/blog/programming/a-requiem-for-a-team/">here</a> )</p>

<p>Does this work for all types of people?  No.  But then again, you&rsquo;ll never get a fast team of developers without hiring the right people.  If you have people on the team that are incapable of being team-players, it&rsquo;s certainly not going to work (and you&rsquo;ll likely have a number of problems).</p>

<p><strong>What if we have TWO top priorities though?</strong>  Flip a coin and pick one; It&rsquo;s that simple.  Just arbitrarily choosing one will get one of them shipped and returning value as soon as possible.</p>

<p><strong>What about team member X that has nothing to do?</strong>  The team should recognize this and:</p>

<ul>
<li><p>try to break down the tasks better so they can help (it&rsquo;s often worth a 30 minute session to bring other people on board &mdash; Any given task can almost always be broken down further with additional design discussion, even if its not worth dividing up the work).</p></li>
<li><p>try to get them pair-programming so they can learn to help better.</p></li>
<li><p>try to get them testing the parts that are done.</p></li>
</ul>


<p>Obviously in some scenarios it might make sense for them to start on the second priority, but they should be ready to drop that work at any time to help get priority #1 out the door faster.  <strong>Remember:</strong> the goal is to ship finished features faster.  It&rsquo;s not to keep the people on the team as busy as possible.</p>

<p><strong>Isn&rsquo;t that really tough on the developers to rarely have quiet time to concentrate?</strong>  Yes, at first it often is, often because focusing on the top priority requires discipline because it&rsquo;s different from the status quo.  And people simply aren&rsquo;t used to the buzz in the room.  The longer you spend working with headphones on, trying to carve out your own niche, separate from the rest of the team, the longer it will take you to transition and the harder that transition will be.  But soon you learn to ignore the irrelevant buzz in the room and to tune back in quickly when it&rsquo;s important and relevant.  And since you&rsquo;re all working on the same thing, it&rsquo;s often relevant, and lot less difficult to get back into the <a href="http://psygrammer.com/2011/02/10/the-flow-programming-in-ecstasy/">flow state</a> than you&rsquo;d expect (especially if pair programming).  So the pay-off for developers is:</p>

<ul>
<li><p>huge productivity improvements</p></li>
<li><p>less waiting for someone else to do their part</p></li>
<li><p>longer sessions in &ldquo;flow state&rdquo; and easier returns to flow state</p></li>
<li><p>less solitude without adding interruptions</p></li>
<li><p>less &ldquo;all the weight is on my shoulders&rdquo; scenarios</p></li>
<li><p>more knowledge sharing and personal development</p></li>
</ul>


<p>It helps a lot if developers take breaks more often, because you actually end up spending a lot more time in the flow state in a given day.  You end up learning more from other developers and being vastly more productive as well, which is exhausting and energizing at the same time.  In my opinion, when done right, it&rsquo;s just a lot more fun than isolated development.</p>

<p>Of course it often also helps to have break-out rooms for smaller prolonged conversation when desired as well.</p>

<p><strong>But what if you have dozens of engineers?</strong>  It&rsquo;s just not reasonable to try to make teams that contain dozens of engineers.  <a href="http://en.wikipedia.org/wiki/Brooks%27s_law">Brooks&#8217; law</a> has seemed to hold fairly well over time and he explains that one reason is that the more people you add to a group, the more communication overhead there is.  I&rsquo;ve personally seen this as well, with team-size starting to get diminishing returns between  8 and 12 people, with little value (if any) to adding members beyond that.  When you get beyond 8 people on a given team, you need to start thinking about creating a second team.  <a href="http://en.wikipedia.org/wiki/Conway%27s_law">Conway&rsquo;s Law</a> seems to dictate that a <a href="http://en.wikipedia.org/wiki/Service-oriented_architecture">service-oriented architecture</a> is the best solution we&rsquo;re going to get for scaling up an organization&rsquo;s developer head-count, but I&rsquo;ve personally found that smaller codebases with distinct responsibilities are generally better codebases anyway.</p>

<p>With all that said, of course I really wish I could work remotely sometimes and get all the same benefits.  I&rsquo;ve simply never seen a telepresence technology set-up that matches the fidelity of actual face-to-face and shoulder-to-shoulder collaboration.  Maybe it exists.  I&rsquo;d love to hear about it.  But my experience simply doesn&rsquo;t indicate that the current status quo technologies (skype, webex, etc), like Remote recommends, are up to snuff.  The way it stands today, I&rsquo;ll almost always put my money on a collocated group of <a href="http://avichal.wordpress.com/2011/12/16/focus-on-building-10x-teams-not-on-hiring-10x-developers/">&ldquo;team-players&rdquo;</a> over a geographically disparate team of &ldquo;gurus&rdquo;.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-09-13T18:47:31-07:00" data-updated="true" itemprop="datePublished">Sep 13<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/apis/'>apis</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/09/13/you-probably-dont-need-to-version-your-web-api/" itemprop="url">You Probably Don’t Need to Version Your Web API.</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>So you’re thinking about versioning your web API somehow.  Versioning is how we annotate and manage changes in software libraries, so it seems natural to re-apply this solution to changes in web APIs.  Most web APIs are versioned in order to…</p>

<p><strong>( A ) “freeze” an older version somehow so that it doesn’t change for older clients, or at least it is subjected to much less change than newer versions, so you can still move forward.</strong></p>

<p><strong>( B ) be able to deprecate older APIs that you no longer wish to support.</strong></p>

<p><strong>( C ) indicate that changes have occurred and represent a large batch of changes at once when communicating with others.</strong></p>

<h2>However…</h2>

<p><strong>( A )  Versions don’t actually solve the problem of moving forward despite older clients.</strong></p>

<p>You can safely break backward compatibility with or without the concept of versions: just create a new endpoint and do what you want there.  It doesn’t need to have any impact on the old endpoint at all.  You don’t need the concept of “versions” to do that.</p>

<p><strong>( B ) Versions don’t actually solve the problem of deprecating old endpoints.</strong></p>

<p>At best, versions just defer the problem, while forcing you to pay the price of maintaining two sets of endpoints until you actually work out a real change management strategy.  If you have an endpoint that you want to retire, you’re going to have to communicate that to all your clients that you’re deprecating it, regardless of whether or not you’ve “versioned” it.</p>

<p><strong>( C )  Versions DO help you communicate about changes in a bunch of endpoints at once.  But you shouldn’t do this anyway.</strong></p>

<p>Of course, if you’re retiring 20 endpoints at once, it’s easier to say “we’re retiring version 1” than to say “we’re retiring the following endpoints…” (and then list all 20), but why would you want to drop 20 breaking-change notices on your clients all at once?  Tell your clients as breaking changes come up, and tell them what sort of grace period they get on those changes.  This gives you fine-grained control over your entire API, and you don’t need to think about a new version for the entire API every time you have a breaking change.  Your users can deal with changes as they occur, and not be surprised with many changes at once (your new version).</p>

<h2>“So how the @#$% do I manage change in my API??”</h2>

<p>With a little imagination, it’s totally possible.  Facebook is one of the largest API providers in the world, and it doesn’t version its API.</p>

<p><strong>Take Preventative measures:</strong>  Spend more time on design, prototyping, and beta-testing your API before you release it.  If you just throw together the quickest thing that could possibly work, you’re going to be paying the price for that for a long time to come.  An API is a user interface, and as such it needs to actually be carefully considered.</p>

<p><strong>Consider NOT making non-essential backwards-incompatible changes:</strong> If there are changes you’d like to make in order to make your API more aesthetically-pleasing, and you can’t do so in an additive fashion, try to resist those changes entirely.  A good public-facing API should value backward compatibility very highly.</p>

<p><strong>Make additive changes when possible:</strong> If you want to add a new property to some resource, just add it. Old clients will just ignore it.  If you want to make breaking changes to some resource, consider just creating a new resource.</p>

<p><strong>Use sensible defaults where possible:</strong>  If you want a client to send a new property, make it optional, and give it a sensible default.</p>

<p><strong>Keep a changelog, roadmap and change-schedule for your API:</strong>  If you want to solve the problem of keeping your users abreast of changes in your API, you need to publish those changes somehow.</p>

<p><strong>Use hypermedia:</strong>  Tell the clients what uris to use for the requests that it needs to make and give them uri templates instead of forcing them to make their own uris.  This will make your clients much more resilient to change because it frees you up to change uris however you want.  Clients making their own uris are tomorrow’s version of parsing json with regular expressions.</p>

<h2>NB!</h2>

<p>Notice that almost all of these are things that you should do regardless of whether or not you version your API, so they’re not really even extra work.</p>

<p>Notice also that I never said “Never make changes”.  I’m not trying to make an argument against changes.  I’m just saying that versioning doesn’t help you make changes at all.  At best it just lets you put a bunch of changes in a “bucket” to dump on your API users all at once.</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-06-09T21:21:46-07:00" data-updated="true" itemprop="datePublished">Jun 9<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/programming/'>programming</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/06/09/my-favourite-new-ility/" itemprop="url">My Favourite New Ility</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>If you’ve ever seen a laundry list of the types of <a href="https://en.wikipedia.org/wiki/Non-functional_requirement">non-functional requirements</a> like testability, accessibility, reliability, etc, (often called “ilities” because of their common suffix) you probably haven’t seen “rewritability”, but I really want to add it to the pile.</p>

<p>I’ve often found in software engineering that counterintuitively, if something is difficult or scary there’s a lot to be gained by doing it more often. I think we can probably agree that software rewrites are <a href="http://www.joelonsoftware.com/articles/fog0000000069.html">amoung</a> <a href="http://www.neilgunton.com/doc/?o=1&amp;doc_id=8583">those</a> <a href="http://chadfowler.com/blog/2006/12/27/the-big-rewrite/">difficult</a> <a href="http://onstartups.com/tabid/3339/bid/2596/Why-You-Should-Almost-Never-Rewrite-Your-Software.aspx">and</a> <a href="http://en.wikipedia.org/wiki/Second-system_effect">scary</a> <a href="http://steveblank.com/2011/01/25/startup-suicide-%E2%80%93-rewriting-the-code/">tasks</a>.</p>

<p>Now that we’re starting to get better at service-oriented architecture, where networked applications are better divided into disparate services that individually have narrow responsibilities, a natural side effect is that it’s getting easier to write services that are replaceable later.</p>

<p>So what makes a piece of software rewritable?</p>

<p><strong>Clearly defined requirements:</strong> not just what it needs to do, but also what it won’t do, so that feature-creep creeps into another more appropriate service. This one ends up requiring some discipline when the best place and the easiest place for a given responsibility don’t end up being the same service, but it’s almost always worth it.</p>

<p><strong>Clearly defined interface:</strong> If you want to be able to just drop a new replacement in place of a previous one, it’s got to support all the integration points of the previous one. When interfaces are large and complicated this gets a lot harder and a lot riskier. In my opinion, this makes a lot of applications with GUIs very difficult to rewrite from scratch without anyone noticing (Maybe it’s because UX is hard. Maybe that’s because I’m terrible at GUIs.).</p>

<p><strong>Small:</strong> Even with clearly defined requirements and interface, a rewrite is still going to be expensive and hard to estimate if there’s a lot to rewrite.</p>

<p>Any software engineers that have found themselves locked into a monolithic ball of mud application can see the obvious upsides of having a viable escape route though.</p>

<p>And once we’re not scared of rewrites, what new possibilities emerge?  Real experimentation?  Throw-away prototypes that we actually get to throw away?</p>

<p>How much easier is it to reason about a piece of software when it also meets all the criteria that make it easy to rewrite?</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-05-07T21:27:20-07:00" data-updated="true" itemprop="datePublished">May 7<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/management/'>management</a>, <a class='category' href='/blog/categories/teams/'>teams,</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/05/07/a-requiem-for-a-team/" itemprop="url">A Requiem for a Team</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I once asked an interviewee “Ever work on a high-performing team?” and he answered “Yeah…” and then went on to explain how his team profiled and optimized their code-base all the time to give it very high performance.</p>

<p>That’s not what I meant, but in his defence, I really don’t think many developers have had the opportunity to work on high-performing teams and so they don’t know what they don’t know.</p>

<p>I’ve been developing software professionally for around 15 years and I’ve only worked on a high-performing team once. It was a couple of years ago, and it was awesome. I haven’t been able to find another since, but now I’m a true-believer in the concept of a <a href="http://avichal.wordpress.com/2011/12/16/focus-on-building-10x-teams-not-on-hiring-10x-developers/">10X team</a>.</p>

<p>I suspect that there might be groups out there somewhere who have experience with even higher-performing teams, but I’m certain that I’ve been on enough teams now that high-performing teams are extremely few and far-between. I’m not sure I even know how to create one, but I know one when I see one. I’ve definitely been on teams since that have been close to being high-performing.</p>

<p>The high-performing team is the ultimate win-win in the software development industry because the developers on the team are thrilled to be going into work on a daily basis and the business is thrilled because they’re producing results much faster and more reliably than other teams. Those are really the two essential criteria, in my opinion:</p>

<ol>
<li>Is everybody happy to be part of the team?</li>
<li>Is the team producing results quickly?
The first criteria is absolutely necessary for the second to be sustainable. Any business that neglects developer enjoyment is taking a short-sighted path that will eventually negatively impact performance (due to burnout, employee turnover, etc).</li>
</ol>


<p>So all of this sounds great, but the real mystery is in how to make it happen. I’m not 100% sure that I know. I don’t think I’ve ever even heard of people talking about how to achieve it.  This is my shot at describing the recipe though.</p>

<h1>The Management</h1>

<p>The craziest part of my experience is that the only time I’ve seen a high performance team happen was when the manager of the team had very little software development experience. That seems maddeningly counter-intuitive to me because from a developer’s perspective, one of the most frustrating aspects of software development is having a clueless person telling you what to do and how to do it. It turns out that being clueless in software development can be a huge benefit to being brilliant at software development management though, if the manager is already brilliant with management in general.  <em>This</em> manager was definitely brilliant on the management side. Here’s why:</p>

<ul>
<li>He hired for attitude over aptitude. He would hire based on peoples’ potential, their attitudes, and their willingness to work hard instead of whether their precise skillset filled a niche that we needed.</li>
<li>He would cull developers who weren’t team players. It’s not a job anyone wants to do, but it’s sometimes necessary to let people go when they’re not working out. Not doing this results in the rest of the team being miserable.</li>
<li>He kept the team small, and didn’t move people in or out of it very often. This gives the team the maximum opportunity to form into a cohesive unit.</li>
<li>He would set clear goals and priorities. No two things would share the same priority (even though I’m sure he was probably secretly flipping a coin when more than one thing was extremely important). That would give the team a clear direction and an ability to focus on what’s most important.</li>
<li>He never explained a requirement with &ldquo;because I said so&rdquo;. This encouraged a culture of questions and feedback which enhanced learning both on the manager’s part and on the team’s part.</li>
<li>Even when priorities would change, he’d let us complete our current work where possible, so that we wouldn’t have a mess of incomplete work lying around to try to come back to later. I’ve been on teams since where the team has been repeatedly interrupted to the point of not really delivering anything for months.</li>
<li>He assigned work to the team, and not to individuals, so the team would have to own it collectively. This kept the manager from being the choke-point for “what should I work on next?” questions.</li>
<li>He didn’t make decisions or solve problems for the team that the team was able to handle themselves (even when individuals on the team would ask).</li>
<li>He’d bring us the requirements, but leave the solutioning up to us. The result was that the team was largely autonomous and in control of <em>how</em> it accomplished its goals, so we immediately had a newfound sense of responsibility for our work and even pride in it.</li>
<li>He’d get estimates from us, and not the reverse (ie. deadlines). This way he could inform the business about what the estimated cost and schedule for a given feature was so they could make informed decisions about what features to pursue, rather than just delivering what was finished when the clock ran out.</li>
<li>He’d actively look for scenarios where the team was not “set up for success” and rectify them.  Nothing is worse for team morale than a <a href="http://c2.com/cgi/wiki?DeathMarchProject">death march project</a>, even a mini-one.</li>
<li>He held the team responsible for the performance of individuals. If someone on the team was struggling on a task (daily stand-up meetings make this pretty obvious) without any help from team, he’d ask the team what they were doing to help.</li>
<li>All of these things created the perfect climate for a high-performing team, but no one person alone (even a great manager) can create a high-performing team on their own.</li>
</ul>


<h1>The Team Member</h1>

<p>The individuals on the team were also really impressive to me and no doubt absolutely essential to making the team what it was. Here’s a loose laundry-list of the qualities I witnessed and tried to adhere to myself:</p>

<ul>
<li>Members of the team were open, honest, and respectful. They would give each other feedback respectfully and truthfully and would never talk behind each others’ backs. On other teams that I’ve worked on where this wasn’t the practice, team-crushing sub-cliques would form.</li>
<li>Once a decision has been made by the team, every member of the team would support it (even if he/she was originally opposed) until new evidence is presented. This actually worked well because we would always first take the time to actually listen to and consider everyone’s opinions and ideas.</li>
<li>Members of the team were results-oriented. “Effort” was never involved in our measure of progress. Software actually <em>delivered</em> according to the team’s standards was our only measure of progress.</li>
<li>The team would continuously evaluate itself and its practices and try to continuously improve them. We’d have an hour-long meeting every week to talk about how we were doing, and how we could improve (and how we were doing implementing the previous week’s improvements).</li>
<li>The team would practice collective code ownership, and collective responsibility over all the team’s responsibilities. This is actually a pretty huge deal; if people working on a top priority needed help, they’d ask for it immediately and anyone that could help would. If someone was sick, someone else would take on their current responsibilities automatically. If a build was broken, everyone would drop everything until there was a clear plan to fix it. The morning stand-up meeting would happen at exactly 9 am regardless of whether the manager was there.</li>
<li>The team would foster cross-functionality as a means of achieving collective code ownership and collective responsibility. What that meant was that members would actively try to teach each other about any particular unique skill-sets they had so that they would be redundant and team members would be better able to take on any task in the work queue.</li>
<li>The team would be as collaborative as possible. We all sat in a bullpen-like environment where we’d torn down the dividers that were originally erected between us. We’d often pair-program, not only for skill-sharing and mentoring, but also for normal coding tasks, because the boring tasks are less mind-numbing that way and the complicated tasks get better solutions that way.</li>
<li>In the 5 or 6 teams in our organization at the time, I think our team was by far the fastest, and most capable of handling the more technically diverse and challenging work. No one on the team was a rock-star programmer, but somehow despite that, the team as a whole was really outstanding.</li>
</ul>


<p>Eventually when this manager moved on, I took the management role and ultimately failed to maintain that environment (partially for a number of reasons that were out of my control, and partially because at the time I didn’t realize the necessary ingredients).  I’ve only really learned them since then by watching dysfunctional teams.</p>

<p>It’s a cliche, but in the right environment, the collective can indeed be greater than the sum of its parts.</p>

<h1>EDIT (June 2nd, 2014):</h1>

<p><strong>I just moved my blog over from wordpress, but I don&rsquo;t want to lose the comments that I had there, because they&rsquo;re great and they&rsquo;re from the team that I was writing about. I&rsquo;m just going to copy/paste them in here for posterity.</strong></p>

<hr />

<p>Todd said on May 8, 2013 at 8:12 am: Edit</p>

<p>You nailed it! I’m glad my simple ‘I miss working with you…’ email triggered you to write this thoughtful post. I admire your choice to spend time sharing your thoughts with the world.</p>

<p>I was trying to come up with some clever addition to your post but I keep typing and erasing. The one constant thought I whole heatedly believe had the most impact on our teams success is ‘Jaret’. I sure hope he doesn’t read this post, they’ll be no living with him! :)</p>

<hr />

<p>Tom said on May 10, 2013 at 7:50 pm: Edit</p>

<p>Gregg and Todd, I also miss working with you guys. I do, however, have some pertinent hymns to add to the post. Though, I must first agree that a highly productive team is not formed from a cookie-cutter, but many ingredients do add to the potential success; kudos to Gregg for identifying most.</p>

<p>Management: I’d add that the “ideal” manager is an advocate for the team’s decisions, approach and methodology even if he does not fully understand them. Specifically, if the team can convince, through reason, that they were not smoking crack and that their solution would be suitable and economical (perhaps not in the short-run, but in the long-run), then he would go to bat for them. He’d do this no matter how much counter-pressure was exerted by upper management; clearly JW did this.</p>

<p>Secondly, a culture of experimentation, collaboration, and trust must trickle down from the upper echelons of management down to the lowest levels. Think of this as an approach to lowering entropy. Without this, all middle managers have their hands tied.</p>

<p>Team: Diversity in cultural and technological background is highly advantageous. The simple reason is that varied backgrounds allow differing opinions, analysis and approaches to a solution. I’d be bold enough to state that a homogeneous team is useless at being highly-productive because there is not enough diversity in the “knowledge gene pool” to forge great solutions. On the flip side, too much diversity may be a hindrance as agreement may be hard to come by for the final solution, but somebody should play devils advocate during the initial discussions; this only comes from varied experiences.</p>

<p>As well, team members should feel as if they are creating something of value. Perhaps this is more of a company or management issue, but I believe if people, regardless of their position in a company, feel like they are contributing to a greater good will naturally help their teammates and this will improve the productivity of the team as well as the firm’s bottom line.</p>

<p>I’m sure there are more comments to add, but I need to go have another glass of wine and reminisce :)</p>

<hr />

<p>Gregg Caines said on May 11, 2013 at 8:12 am: Edit</p>

<p>Ha Good to hear from you Sykora :) I agree with your points. I think JW was set up for success when the “upper echelons” were supportive, and we were all destined for failure once those winds changed and upper management suddenly cared very deeply about the team’s every move on a day-to-day basis. Something makes me think that even if they had a reasonable ratio of right/wrong in their technical decisions, we’d still be irritated to be completely out of control of our own destinies, especially given our history of self-organization. Once the team gets a taste of autonomy, it’s hard for them to go back to command-and-control management. I suspect you of all people would agree.  ;)</p>

<p>I agree with you on diversity too. We had a pretty diverse team but I think it worked well because we were respectful and trusted each other. I’ve seen teams since that were much less diverse and would argue disrespectfully about tiny things compared to some of the things that we would (calmly) discuss and (quickly) resolve. I’ll tell you one thing that I know for certain now: egos don’t make good team-mates.  ;)</p>

<p>I agree with the “creating something of value” point as well, but I’m less about the value to the customer and more about the engineering craftsmanship. It’s the only way I’ve found myself able to reconcile product decisions I can’t agree with. Maybe one day I’ll have my greasy hands in the product side as well and get a chance to care all the way through though.  ;)</p>

<hr />

<p>tibi said on May 11, 2013 at 9:11 am: Edit</p>

<p>Well that was a nice post. And now I miss the team even more. I think you hit it right on the head (I can’t correctly remember the nail euphemism :&ndash;) )…</p>

<p>I’ve been looking for the same dynamics in a team ever since, and I think I’m getting close, but there is always something missing. Perhaps it’s the Tim Horton’s cup arch…</p>

<hr />

<p>Jeff said on May 11, 2013 at 3:53 pm: Edit</p>

<p>Some great thoughts here Gregg – on the money pretty much across the board. A team is definitely only as good as it’s leadership allows. I’ve been in situations where the core team was incredible and worked together well but ultimately failed for the various reasons you any Tom both mention.</p>

<p>p.s. Hiya boys – hope everyone’s doing well.
Did someone say Tim’s?</p>

<hr />

<p>Gregg Caines said on May 13, 2013 at 9:01 am: Edit</p>

<p>Tibz and Jonesy! Good to see you two are still alive.  :)</p>

<hr />

<p>Chris said on May 14, 2013 at 7:06 am: Edit</p>

<p>It was something special to watch and interact with.</p>

<p>You do not really know what you’ve got until it’s gone, eh? There was a sense of what was happening but probably also a sense that it would fairly easily be recreated.</p>

<p>My current co-workers are tired of hearing how “we would have did it at my last place.” ;) Somehow it is not fair to hold other teams to that yardstick.</p>

<hr />

<p>JW said on June 10, 2013 at 8:56 am: Edit</p>

<p>So many great things have been said above – and I have to agree with all of it. From my perspective, it really was a dream team. The trust, collaboration and commitment levels in the entire office were exceptional.</p>

<p>I have read numerous books on leadership and when I reflect on that team, we had all the characteristics of a high performing team.</p>

<p>For me, I loved the level of achievement, craftsmanship, and fun that we had. It wasn’t work – even a few of those late nights weren’t too bad because we were doing it together.</p>

<p>Is there a secret sauce to recreate that environment? Not that I have found. However, I have been lucky enough to be part of 4 different high performing teams over my career, and I believe there are things we can all do to help create an environment that could support a high performing team. From there – it is up to the team to choose to be high performing.</p>

<p>I identify well with the Patrick Lencioni’s book “The 5 Dysfunctions of Team”. Although I will not rewrite each of the characteristics from the book, I feel that we need to provide special mention to trust. It is the foundation of a high performing team. Nothing can be built without it. That means we need to know our team mates and their goals. How can we help each other? The more we help and recognize each other, the quicker the team will want to collaborate and achieve greater things.</p>

<p>We are all lucky to have been part of something great. I learned a ton from everyone there and I share those insights in my classes everyday.</p>

<p>Gregg – many thanks for starting this thread.</p>

<hr />

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-29T21:45:09-07:00" data-updated="true" itemprop="datePublished">Apr 29<span>th</span>, 2013</time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/29/so-i-wrote-a-json-api-framework-and-the-framework-was-the-least-interesting-part/" itemprop="url">So I Wrote a JSON API Framework and the Framework Was the Least Interesting Part</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h1>First a little background</h1>

<p>I’ve always been a big fan of<a href="http://www.ics.uci.edu/~fielding/pubs/dissertation/top.htm"> REST the way Roy intended it</a> for two major reasons:</p>

<p>It uses HTTP the way HTTP was intended, playing on its strengths and not wasting any time re-inventing what HTTP already has.
The state of HTTP APIs these days is really ridiculously bad, given what we should have learned from the unfathomable success of the WWW.
I was also envious as hell at the great framework Erlang developers had in <a href="https://github.com/basho/webmachine">Web Machine</a> .  If you write HTTP APIs for a living and you haven’t seen HTTP mapped to a state machine, you really owe it to yourself to <a href="https://github.com/basho/webmachine/wiki/Diagram">check it out</a>.  It’s brilliant.</p>

<p>The thing I really wanted to do though was make web APIs not so terrible.  There are a few reasons that I think they’re terrible:</p>

<ul>
<li>You have to read reams of documentation to do the simplest things, like finding the URL for something.</li>
<li>You have to hard-code urls all over your client app.</li>
<li>When you do something wrong, there’s no consistency in error output.</li>
<li>Knowing HTTP doesn’t make it any easier to predict how something will work.</li>
</ul>


<p>If you rely on someone else’s API in your day-to-day work, you probably know what I mean.  I’m not going to name any names (but here’s a clue: one of the worst offenders starts with an F and rhymes with Facebook).</p>

<p>So the APIs I wanted to make and to use would be:</p>

<ul>
<li>semantically consistent with plain old HTTP</li>
<li>discoverable, like other pages and controls on normal HTML web sites are discoverable.</li>
</ul>


<p>Luckily HTTP is also the vanguard of API discoverability, most often in the form of hypertext (So that’s what that H stands for!) .   I’m a bit blown away that this wasn’t obvious to me earlier, but luckily I stumbled into <a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">Roy Fielding talking about hypermedia</a> and I realized that that’s precisely the correct way to solve the discoverability problem.  He was saying real REST APIs should minimize out-of-band knowledge by leaning on what HTTP’s already got: links! <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> .</p>

<p>Then I saw <a href="http://vimeo.com/20781278">Jon Moore make it real with an XHTML API</a> .  XHTML forms are a method of discoverability as well?!? My mind was blown.  Think about that: XHTML documents tell you what kind of write-possibilities the API has.  You don’t need to read docs to find out!</p>

<p>And then I saw <a href="http://amundsen.com/media-types/collection/format/">Mike Amundsen bring it all back to json</a> and I knew it might be something I could actually use in the real world and people trying to Get Stuff Done wouldn’t want to hunt me down and murder me in my bed (especially since I’m also a card-carrying member of the People Who Want To Get Stuff Done Liberation Front).   I think most of us are of the belief that XHTML isn’t going to unseat json as the preferred media-type for APIs anytime soon.</p>

<p>Armed with all this inspiration, I wrote a web-framework.  I ended up picking node.js mostly because the <a href="http://nodejs.org/api/http.html">HTTP line-protocol</a> stuff was already covered there without any extra cruft to get in my way, so I was free to try to aim for “Web Machine with json with links”<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>, which I call <a href="http://percolatorjs.com/">Percolator</a>.  The framework isn’t the interesting part though; it’s the stuff I learned along the way, which can be done in any framework/language/platform, even if it’s not baked into the framework.</p>

<h1>The First Interesting Part:  Hypermedia apis are indeed awesome</h1>

<p>I started by just putting links in my json to other endpoints that make sense.  That made my json APIs so much easier to use, even when the user is me.  I had one endpoint for my entire API and every other endpoint was discoverable by following links.  I used <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc?hl=en">JSONView for Chrome</a> and <a href="https://addons.mozilla.org/en-US/firefox/addon/jsonview/">for Firefox</a> and I could click around my entire API testing the GET method on every endpoint just by clicking.  Here’s how it looks:</p>

<p><img src="/images/json-with-links.png" title="[ json with links [ json with links ]]" ></p>

<p>Those purple links are visited links that you can actually click on and get a new API response.  I showed some co-workers that were using my API and eventually they stopped asking “Hey what’s the URL for getting X again???”  They could always easily re-find it themselves.</p>

<p>Adding links also pays off when humans aren’t involved.  In many cases it means that the client doesn’t need to construct its own links.  For example: when one of my APIs was being used for replication by a client app the client developer asked how we’d handle pagination, because he wanted to page through all my results to replicate my API’s data elsewhere (sort of like how <a href="http://wiki.apache.org/couchdb/Replication">couchdb replication works, which is simple yet amazing</a> ) .  I had a pagination scheme working, but it didn’t make use of the database indices as well as I wanted so I told him instead to just follow the ‘next’ link and not to worry about the parameters for constructing the URL at all and that the absence of a ‘<a href="http://www.w3.org/TR/html4/types.html#type-links">next</a>’ link would indicate the end of the results.  What this meant for me is that when I changed the pagination scheme to something more friendly to my database, I didn’t even have to tell him.  What it meant for him is that he never had to change anything on his side to support the new form of pagination, and he didn’t have to construct any urls.</p>

<p>It blows my mind that pushing this simple technology further could end up with clients ONLY needing to store the root URL of the API, and not a who’s-who of possible disparate endpoints that practically mirrors the routing table on the server.    People are actually starting to <a href="http://vimeo.com/20781278">push the envelope this way</a>.  Wouldn’t it be great if at some point we could stop writing client software that’s hopelessly <a href="https://github.com/ttezel/twit">service</a>&ndash;<a href="https://github.com/arsduo/koala">dependent</a> ?  Wouldn’t it be great if one day client-side url construction was considered as silly as using regexes to get data from json?</p>

<p>I should also add that even if you’re writing both the client and the server, which happens a lot with single-page apps and mobile apps, you might be tempted to think this is a waste of time, but in my experience it makes testing and debugging much easier and helps me remember what my API does after a month without using it despite my terrible memory.  That minor extra effort of adding links pays for itself over and over again.</p>

<h1>Interesting Part #2: JsonSchema is surprisingly awesome</h1>

<p>Of course once I could surf around my API, it didn’t take long for me to bemoan the fact that I could only peruse GETs this way.  I had seen <a href="http://vimeo.com/20781278">Jon Moore’s XHTML API demo</a>  (This is my third link to it here, so you know it’s worth a watch!) , and I was jealous of how XHTML forms could describe the POSTs as well.  Originally I decided that json needed forms as well, but the big brains in the <a href="https://groups.google.com/forum/?fromgroups#!forum/hypermedia-web">Hypermedia-Web Google Group</a>  convinced me that I could just expand my link concept to know about other HTTP methods.   And I had already stumbled upon <a href="http://json-schema.org/">JsonSchema</a> as a way to specify what was expected in a PUT or POST payload, just like XHTML forms can do (but still using json of course).</p>

<p>JsonSchema is a particularly elegant solution to the problem, because I can write all my validations in JsonSchema, publish the validations as json to the api (JsonSchema is just json afterall), and then on the client side re-use them for validations before I even bother with an http request to the api.  This way I can use the same validations on the client and server, AND communicate them naturally as part of the json payload.  The end result was that my json APIs could now fully communicate everything that was possible via the json API itself.  Here’s how it looks:</p>

<p><img src="/images/json-with-write-link.png" title="[ json with POST link [ json with POST link ]]" ></p>

<p>I added baked-in JsonSchema support to Percolator right away of course, but you can do it easily in <a href="http://json-schema.org/implementations.html">any of the most popular languages  ( see the validators tab)</a>.  Currently I haven’t implemented any clients that use it for validations yet, but I do use it for my server-side validations.  More importantly still, it communicates to humans everything that’s necessary for a successful PUT or POST. <sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup></p>

<p>Ultimately the addition of JsonSchema lead me to add a static frontend to Percolator that, after abstracting it away, I published separately as the <a href="https://github.com/cainus/hyperjson-browser">Hyper+JSON Browser</a> .  You don’t need it, but you can use it in conjunction with Percolator apps to ‘browse’ them even more easily than JSONView does (and without installing a plugin).  Any app (using any language/framework) that spits out the same sort of output as Percolator could use this the Hyper+Json Browser just the same, because it’s a static single-page app that works over any API that works similarly.  Here’s how it looks in use:</p>

<p><img src="/images/browser1.png" title="[ simple Browser view [ simple Browser view ]]" ></p>

<p>When you click on that ‘create’ link to POST, it does this:</p>

<p>Browser after clicking the POST link
<img src="/images/browser2.png" title="[ Browser after clicking the POST link [ Browser after clicking the POST link ]]" ></p>

<p>That red json logo indicates that you haven’t entered valid json (yet).  Pressing OK will actually POST the json that you enter and show you the result.</p>

<p>Here’s a view of another resource (an individual item in the list from the previous collection resource, which can be found by clicking that item’s &lsquo;<a href="http://www.w3.org/TR/html4/types.html#type-links">self</a>&rsquo; link.  It shows delete and update links for this particular resource.</p>

<p><img src="/images/browser3.png"" title="[ Browser after clicking one of the items in the list [ Browser after clicking one of the items in the list  ]]" ></p>

<p>People have likened this to the <a href="http://www.djangobook.com/en/2.0/chapter06.html">Django admin interface</a>, which is a huge compliment, not only because the Django admin interface is pretty legendary, but also because this frontend doesn’t know a single thing about the API other than the requirement that the API uses the aforementioned link format.  This is an area where I’m really excited: In what other ways can other programs use these APIs without foreknowledge?  (I’m not really talking about intelligent agents  – they’d need to understand a little more than the API provides — but dumber things that still use human interaction eventually, like automatic HTML form generation, are mostly possible.)</p>

<h1>(Somewhat less) Interesting Part #3:  Object-oriented routing leads to less stupid stuff</h1>

<p>I hate to sound old-school, but sometimes the object-oriented paradigm maps to a problem better than a functional one.  In this case, I’m talking about routing.  I don’t know why the HTTP methods GET, POST, PUT, etc are named “methods” but it sure does make perfect sense, because each one is tied to a particular “resource”: that “thing” you’re interacting with by using the HTTP methods for a given URL.  It should be obvious then that HTTP resources should be the thing we route to, and not disparate methods.  REST APIs are supposed to be the antithesis of RPC, but when routing involves the method as well, developers tend to make less RESTful APIs and framework developers tend to mess up some of the finer points of HTTP.  Here’s a quick test:</p>

<ul>
<li>Grab your favorite web framework and create a resource with a single GET handler.</li>
<li>POST to it.  Did you get the proper 405 response?</li>
<li>send an OPTIONS request.  Did it tell you that only GET was available?</li>
</ul>


<p>Probably not.  Web-machine gets this right because it routes to the resource, instead of disparate functions that when imagined together form a resource.  I wrote Percolator to work like web machine in this way, because I wanted my APIs to look like something other than a haphazard collection of RPC calls without requiring a lot of self-discipline.  The result is that Percolator responds with 405s when a client tries a method that that resource doesn’t support, and also responds to OPTIONS requests with a list of all the allowed methods.  The result again is better discoverability without reams of documentation, and better feedback for client developers when they’ve done something the API doesn’t support.</p>

<p>There are advantages to OO routes for application developers to though, organization-wise:</p>

<ul>
<li>All routes for a particular resource are connected to that resource, so there’s no chance of sloppy intermingling in the source code.</li>
<li>A bunch of code that you have to write in each method can be written just once for the resource.</li>
<li>You start to see patterns in what resources do, which can lead to certain classes of resources that can be re-used over and over, sometimes wholesale and sometimes with particular strategies that change them slightly.  This is a bit of a big deal, in my opinion because it’s extremely rare that I see this kind of re-use in web applications in the real world.</li>
</ul>


<p>Anyway:  Percolator is indeed ready for production use (at least for the use-cases for which I’ve used it in production!).   It’s extremely fast and extensible, and I hate it a lot less than anything else I’ve used for json REST APIs.</p>

<p>Hopefully it helps someone make a nice API, or it gives some other framework developer some new ideas.  The APIs we have today cannot possibly be the best that we can do.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>plus a pile of other conventions<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>Ultimately I diverged quite a bit from Web Machine, but it was always a huge inspiration.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>Alright not everything, but a heck of a lot.  Linked documentation on my RELs would be another huge boost to discoverability.<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-21T22:22:07-07:00" data-updated="true" itemprop="datePublished">Apr 21<span>st</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/apis/'>apis,</a>, <a class='category' href='/blog/categories/http/'>http</a>, <a class='category' href='/blog/categories/rest/'>rest,</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/21/3-terrible-anti-patterns-for-error-handling-in-rest-apis/" itemprop="url">3 Terrible Anti-patterns for Error-Handling in &#8216;REST&#8217; APIs:</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I’ve seen these anti-patterns in a lot of web APIs, so I thought I’d detail why they’re bad and what to do instead.</p>

<h1>Using a 200 status code for every response:</h1>

<p>This anti-pattern is common for SOAP-like RPC APIs.  Using a 200 status code for all your responses is silly because you end up having to reinvent an error-indication in your response body instead, and nobody in the world knows your new standard (or wants to have to learn it).</p>

<p>It’s also extremely confusing in the cases that an error has occurred because a status code of 200 means everything is A-OK.  <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">There are already a bunch of error codes in the 400 and 500 ranges</a> that are fully capable of indicating all sorts of common problems. It’s still great to put an error message in the response body, but there should be a 400 or 500-level status code so people know that an error even occurred and don’t go ahead and try to interpret the response body as normal or otherwise assume a success.</p>

<h1>Using a 500 status code for all errors:</h1>

<p>This anti-pattern is common because 500 is what most frameworks will do when a web application throws an uncaught exception, and so it becomes convenient to just throw exceptions and not worry about the repercussions. This is mildly better than using a 200 status code for literally everything, because at least it shows an error occurred but it still causes a lot of confusion for client developers.</p>

<p>When you 500 for an error (even if your web framework did it for you), you’re signalling that the problem with the request was the fault of your application (the server) and it’s possible that retrying the request will be successful. Because 500 errors indicate an internal <strong>server error</strong>, they shouldn’t actually ever happen though<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> — In general, you’ve got a bug in your application if they do, and the web server will tell everyone about it. The right thing to do, if there’s something wrong with the request is to respond with the appropriate 400-level status code.</p>

<p>Using a 500 error when a 400-level status code is more appropriate is obviously really confusing to the person making the requests because it doesn’t even let them know that their request needs to be fixed. Even if that person is also you, it forces you to start digging into your back-end for what could possibly just be a bad client request. If you don’t know which 400-level code to use, at the very least use 400 (Bad Request) itself. This will at least give your client developer an indication if the blame is on the server or the client and cut your debugging in half. A few words about the error in the response body can go a long way as well.</p>

<h1>Logging 400-level codes at ‘error’ level:</h1>

<p>Logging is pretty important to measuring the quality of implementation of an API, and learning about specific defects. The ‘error’ level in your logs should be a way to indicate “things that should not have happened that are within this application’s control”, so that you actually have a hope of attempting a 0-error policy. 400 level codes are errors of course, but they’re client errors, and not your server application’s error, so they should not be logged as errors along with your actual 500-level errors (Of course you might still log them as “info” level to keep track of what kinds of crazy things your clients are doing).</p>

<h1>Why do all these details matter?</h1>

<p>When you have an interface between two applications (the client and the server in this case) like HTTP, it REALLY simplifies things a lot if they communicate whether messages are acceptable or not (and why). Even if you control both ends of the interaction, you can save yourself a lot of server-side debugging by having the server indicate what exactly went wrong with a given request, instead of repeatedly reading stack traces every time some JSON you POSTed is missing a property. Compared to how little extra work there is involved in communicating the problem correctly, it’s pretty short-sighted to just let all exceptions bubble-up, or catch all exceptions silently (and 200).</p>

<p>Keep in mind too that if you’re now convinced that communicating errors is important, then HTTP already has a system for just that: HTTP status codes (plus whatever specifics you want to additionally communicate in the response body). Status codes are part of the greater HTTP standard that a lot of developers, libraries, proxies, and caches already understand. Re-inventing your own error mechanism is generally a waste of everyone’s time (with you at the top of the list).</p>

<p>Getting this right is a real time-saver over the long-haul even if you’re the only consumer of the API writing both client-side and server-side.  The time-savings only multiplies as you add more clients.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Sometimes 500 is appropriate of course: If your application requires a database and its lost connectivity to it, then a 500 makes total sense. It signals that there’s a problem in your application and the client can possibly try the request again later.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>


		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2014

    Gregg Caines


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
